---
title: "PIXIV SUMMER BOOT CAMP 2022 インフラコースに参加してきました"
emoji: "🧑‍💻"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["インターン", "pixiv", "MySQL", "Datadog"]
published: false
---

# PIXIV SUMMER BOOT CAMP 2022 インフラコースに参加してきました

8/17~8/26の8日間、PIXIV SUMMER BOOT CAMP 2022のインフラコースに参加してきました。

![](https://user-images.githubusercontent.com/43127622/187212472-98d60453-c4c5-4ebf-b6fe-ca55c7fa55fe.png)

![](https://user-images.githubusercontent.com/43127622/187397268-30874727-e194-4f08-a2c2-36f69dfd2ca7.png)

[技術職向け夏インターンシップ「PIXIV SUMMER BOOT CAMP 2022」参加者募集のお知らせ](https://www.pixiv.co.jp/2022/05/16/130000)

# 応募

エントリーには、通常エントリーとGitHubエントリーがありましたが、僕はGitHubエントリーで応募しました。普段からGitHubを使っていて、開発の様子をそれなりに見せられるようになっていたので、せっかくならこれでエントリーしてみようと思いました。

GitHub選考のレベル感は、GitHub選考で通過していた方や、通過していたよと言われた方の記事を参考にしていました。

- [pixivの夏インターンに参加してきた話](https://kazblog.hateblo.jp/entry/2018/09/12/181008)
- [ピクシブでインターンしてきました！](https://cocu.hatenablog.com/entry/2015/03/16/043343)

自分が話せるリポジトリをピン留めし、その内容が分かるように整備をしていたつもりです。選考を通過できたGitHubアカウント ([@Hiroya-W](https://github.com/Hiroya-W)) の1つとして参考にしてください。

また、GitHub選考であったとしても、ES内で自分が何をやってきたのかを埋める項目はありました。今まで参加したコンテストやハッカソン、バイト経験など書ける項目はURLと合わせてたくさん書きました。

pixivでの選考に限らず、自分が開発経験あることのアピールとして、面接時の話のネタとして質問されやすいし、自分も答えやすくなると思うのでWin-Winだと思います。

# 面接

Google Meetを使ってオンラインで面接しました。ESでも書いていますが改めて、どういったことやってきたのか、から話を深堀りしていったような話をしたと思います。

また、面接の時間に、コーディングテストも含まれています。過去の参加記事を読んでいるとオフラインで面接された方はホワイトボードで書いている様子を見かけますが、それのオンライン版って感じです。

好きな言語を使っても良いということだったので、普段良く使っているPythonで書きました。書けるか、も大事ですが、思考の部分も話せると良く、分からないところがあっても、こういったことをやりたくて、こういった方法で出来たと思います、というのを話ながら書き進めればOKでした。

pixivではPHPをよく使っている印象で、自分はPHPを書いた経験が少ないので大丈夫かなと思っていましたが、特に聞かれませんでした。インターンの課題の内容からもPHP以外で少なくともプログラミング言語が使えれば問題ない、という感じだったのかな、と思います。

# 課題内容

インフラコースでインターンに参加していて、取り組んだ課題の内容はこのような感じです。

- 各テーブルのカラム上限値監視スクリプトの作成と可視化
- MySQLのmaster昇格自動化検討と実現

課題に対するモチベーションとして、期間中に聞いた話は概ね公開されているようなので、スライドも参考になると思います。

@[speakerdeck](c3462d2f08ef4a7b8604e7abc10dfd1a)

## 各テーブルのカラム上限値監視スクリプトの作成と可視化 

MySQLにあるAUTO INCREMENTのカラムは、そのカラムタイプ(INT, BIGINT)で上限値があり、上限値に達したテーブルには新たにデータをINSERTすることができなくなってしまいます。ALTER TABLEでカラムタイプを変更する、というのは単純な話ではなく、大きなテーブルに対しては変更に時間がかかってしまいます。

そのため、余裕を持って対応出来るように、日々監視しておきたいというモチベーションです。スライドP.49を見てみると、並列に処理して対応する方法が確立されているようです。監視は、Datadogを使って可視化することで行います。

## MySQLのmaster昇格自動化検討と実現

MySQLデータベースサーバのデータを複数のMySQLデータベースサーバに複製する、レプリケーションが設定されています。レプリケーションにおいて、masterに障害が発生した時などにslaveをmasterに昇格させる作業を自動化したい、という課題です。

迅速な障害復旧のため、属人化しないためにも自動化出来ると嬉しいというモチベーションですが、よくよく考えると気にしなければいけないことが山ほどある課題です。スライドではP.22あたりからあるmaster昇格の手順ですね。自動化を実現するために、使えそうな構成方法、自動化しやすいようにするにはどうするべきか、といったことを考えていきます。

# インターン開始！

![DSC_1067](https://user-images.githubusercontent.com/43127622/187212607-f94a8315-035f-4a65-aee9-e0f5a6fb945c.JPG)

オフラインで参加していましたが、絵馬が飾ってあったり、吹き抜けのオフィスで端から端まで1つに繋がっているテーブルなど、どこ見ても楽しい感じでした。

## ノベルティ

インターン生用パーカーを含むノベルティもいくつか頂いていて、インターン期間後半はずっとパーカーを着て作業していました[^6]。

![DSC_1181](https://user-images.githubusercontent.com/43127622/187212233-60cbf30f-936a-4e10-9a3c-eb5288b47bb7.JPG)


## 開発環境

期間中はM1 Macbook Airをお借りして作業していました。M1 Macbook、初めて触ったんですが、あまりにもサクサク動いて快適で欲しくなりました。開発環境としてはディスプレイも用意されていて、後は自分で持ち込んだHHKBという感じです。

メンターのdekovokoさんもHHKBを使われていて、他にも(自作っぽい？)分割キーボードを使っている社員の方も見かけました。Slackでもキーボードの話で沼みたいな話が飛び交っていたので、話してみたかったです[^7]。

Slackにも招待されますが、Notionにも招待され、作業ログなどはNotionのカンバンを使ってチケットを切る、そこにまとめていく、というやり方を取っていました。

## 1日目

出社後、まずはインターン期間中のスケージュールの説明を受け、秘密保持契約の手続きをします。この時、各コースにインターン生は1人しかいないことを知って驚いたのと同時に、8日間頑張ろうって気合を入れ直しました。 

それが終わればメンターさんと顔合わせをして、作業を進めていきます。

- 開発環境のセットアップする。
- 同じタイミングでインターンに参加していた他のインターン生とそのメンターの方とランチに行く[^1]。
- オフィス見学をする。
- pixivのベニヤ機サーバを見に行く[^2]。

最近はクラウドを活用することが多く、あまり物理サーバを意識していなかったんですが、やっぱり物理サーバがあるんだな、って気持ちになりました。当たり前ですが。

この後は、課題の説明、課題を進めるためのキャッチアップなどをしていただいた後に、実際に課題に取り組んでいきました。

- 現状のpixivのMySQLデータベースサーバの運用方法について勉強する。
- 3台のMySQLサーバを使って実際にレプリケーションの設定をやってみる。

## 2日目~6日目

2日目からはゴリゴリと課題を進めていきます。

- AUTO INCREMENTの値を取得するクエリを作る。
    - このようなクエリになりました。

```sql
SELECT
   col.TABLE_SCHEMA,
   col.TABLE_NAME,
   col.COLUMN_NAME,
   col.COLUMN_TYPE,
   tab.AUTO_INCREMENT 
FROM
   information_schema.columns AS col 
   JOIN
      information_schema.tables AS tab 
      ON col.TABLE_NAME = tab.TABLE_NAME 
WHERE
   col.extra = "auto_increment" 
   AND col.TABLE_SCHEMA NOT IN
   (
      "information_schema",
      "performance_schema",
      "sys",
      "mysql"
   )
;
```

- Pythonからpixivの全MySQL masterサーバに接続して、クエリを投げられるようにする。
- Datadogカスタムチェックを利用して、Datadogにメトリクスを送信出来るようにスクリプトを調整する。
- 作成した監視スクリプトをデプロイするようにAnsible Playbookに追記する。
- Datadogダッシュボードでの可視化方法の調整する。
    - ダッシュボードでは、3つのウィジェットを用意して、それぞれに`BIGINT`、`UNSIGNED INT`、`(SIGNED) INT`のカラムタイプの値を可視化する。
        - カラムタイプごとに上限値が異なるので、`UNSIGNED INT`だと思っていたら、`SIGNED INT`でした、という誤解を招かないようにする。
- `INFORMATION_SCHEME`にアクセスする際の懸念点を調査する。
    - 調べてみると、MySQL 5.5から5.6でデフォルト値が変更されている`innodb_stats_on_metadata`があったり[^3]、MySQL 8.0では `INFORMATION_SCHEME`のデータがキャッシュされる[^4]ようになったりしています。
    - こういったものが影響していないか、ドキュメントやMySQLのソースコードから挙動をまとめて、要件に合うように対処しました。

インターン期間中に一部の本番環境で適用まで行い、しばらく監視と検証している段階です。問題が無ければインターン後には本格的に動かすことになるようで、残すものが出来て嬉しいです。

## 7日目午前

- 2つ目の課題の調査と、調査出来たことをまとめる。

2つ目の課題に対しては、4日目や5日目の合間から少し調べ始めていて、気になっていたところをもう少し調べなおし、まとめる時間にしていました。

master昇格の自動化のためにまとめた内容としては、このような感じです。

- MySQL MHAを使ったmaster昇格について調べる[^5]。
- ツールを使わず、自分たちでスクリプトを用意する場合に自動化しやすい方法として使えるもの
    - 非同期レプリケーション / 準同期レプリケーション のメリット / デメリット
    - ポジションベース / GTIDベース のメリット / デメリット

1つ目の課題が思った以上に良い内容でほとんどの作業時間を使ったため、2つ目の課題に取り組んで検証するところまで余裕はありませんでした。機会があれば、検証の部分を続けてやってみたいです。


## 7日目午後

最終日の成果発表のため、スライド作成を進めます。

## 8日目(最終日)

引き続きスライドの作成を進めていました。発表は17時からなので、それまでにメンターさんにレビューしていただいて修正したり、通して発表時間の調整を行っていました。

発表時間は10分間なのですが、その中でやったこと、なんでそうしたのか、どうやってやったのかなど、話すことの取捨選択はアドバイスを頂いて無事収まりました。ありがとうございました...！

成果発表では、同じ8/17~8/26の期間で参加していたデータ分析コース、VRoidコースのインターン生の発表が同時に行われました。良い発表だったし、モリモリの成果があった様子を感じて、インターン生のレベル感を感じていました。

## 業務以外で

課題に取り組むだけでなく、いろんな場面で話をさせていただく機会がありました。技術や仕事の話をはじめ、趣味の話まで出来る環境はとても良かったです。

- ランチ
- お茶会
- 面談
- エンジニア勉強会
- 金曜日仕事終わりのオフィス[^8]

# さいごに

インターンの案内に、以下のように書かれていますが、

> 「PIXIV SUMMER BOOT CAMP 2022」では、大きく分けて4つのコース（全17コース）を用意し、本番環境のAPIを叩き、レビューをうけながら、実際に普段から社員が行っている業務にチャレンジすることができます。

インフラコースでも本番環境を見に行ったり触ったりさせていただき、インターンでそこまでやらせてもらえるんだと驚きました。

本番環境で動かしても問題無いように、生半可なスクリプトや設定は入れられないし、本番環境で動かしても大丈夫なように、これをするとどうなるのか、サービスへの影響はあるのかをイメージして、事前にしっかり検証していく大切さを強く感じる機会になりました。普段は、動かしてから様子見ようかな、動かなかったら直していこうって感じでやっていました。これがインフラであれば、サービス障害を簡単に起こせてしまう可能性があって、慎重にならないと、と考え直しました。

また、MySQLデータベースサーバの運用を中心に、pixivのインフラがどうなっているのかを沢山見せていただきました。今、自分が使える技術が業務でどう使われているのかを見れただけでなく、知らなかった技術はもちろん、知っていたけど使ったことが無かった技術や、今までよく分からずに使っていた設定にも触れることができ、インターン期間中に身につけられた技術も多くあります。

メンターのdekovokoさん、インフラ部の皆さん、ありがとうございました。
充実した8日間のインターンでした。

https://twitter.com/Hyuyu_kun/status/1563127383678656512?s=20&t=X-vusaAqwpJtgXXfReizUA

[^1]: pixivリクエスト、データ分析コースの子とご一緒しました！
[^2]: ベニヤ機サーバは[ココらへん](https://atmarkit.itmedia.co.jp/news/201007/21/pixiv.html)の写真のやつですね。楽しかったです。
[^3]: https://dev.mysql.com/doc/refman/5.6/ja/innodb-parameters.html#sysvar_innodb_stats_on_metadata
[^4]: https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_information_schema_stats_expiry
[^5]: [mha4mysql-manager](https://github.com/yoshinorim/mha4mysql-manager)と[mha4mysql-node](https://github.com/yoshinorim/mha4mysql-node)によって、masterに障害が発生した時に自動的にフェイルオーバーする仕組みを実現することができるようです。
[^6]: ダンボール箱に入った状態で頂いたのですが、東京から持ち帰る時に中身だけにして持って帰ってきて写真撮りました。
[^7]: 僕はキー配列を変えているので、このHHKBを持ち込むか、何らかの方法で配列を変えられないと、就職した時にQWERTY配列にまた戻さないといけなくて辛いなって思ってたのでいい話です。
[^8]: 26日の夜は集まったメンツで、にじさんじ甲子園2022 エキシビションを見ていたようです。帰りの新幹線の時間が無ければ、僕も一緒に見たかったです...。
