---
title: "HM-StarterKit RX631マイコン開発環境をLinuxで作る"
emoji: "🛠️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["VSCode", "Linux", "Renesas", "RX631"]
published: false
---

# HM-StarterKit

[HM-StarterKit 手のひらサイズのマイクロマウス学習キット](https://rt-net.jp/products/hm-starterkit/)

- CPUボード	RX631（R5F5631MDDFL）

HM-StarterKit の開発環境を作ろうと思ったが、取扱説明書で推奨されている統合開発環境の [CS+](https://www.renesas.com/jp/ja/software-tool/cs) は Windows にしか対応していない。

Renesasが提供している統合開発環境にはCS+の他にも[e2 studio](https://www.renesas.com/jp/ja/software-tool/e-studio) がある。
CS+ではRenesas独自コンパイラを利用する一方、e2 studioではコンパイラとしてGNUコンパイラを利用できる。
GNUコンパイラは独自拡張されているが、Windowsだけでなく、Linux向けにもバイナリやソースコードが提供されているため、Linux上でも利用出来る。

Linux版のe2 studioも存在するが、今回利用するRX631を含むRX Familyには対応していない。
そのため、Linux上でe2 studioを使ったRX631マイコンの開発環境は残念ながら使えない...[^1]。

## やること

Windows上のe2 studioで自動生成出来る部分のソースコードを利用し、Linuxではコンパイラの環境を構築する方針で開発環境を作ることにした。

- e2 studio 2022-04 for Windows
- Toolchain Renesas v8.3.0.202202-GNURX

# GCC for Renesas 

Linuxで開発するには、CS+は使えないので、独自拡張されたGCC Toolchain(GCC, Newlib, Binutils, GDB)を使うことにする。  
これらのソースコードと、ビルド済みToolchainのインストーラは以下から取得出来る。なお、ビルド済みToolchainのインストーラを取得するにはRenesasアカウントの登録が必須となっている。

- [GCC for Renesas vX.X.X.YYYYMM-GNURX Source Code](https://llvm-gcc-renesas.com/ja/rx/rx-latest-source-code/)
- [GCC for Renesas X.X.X.YYYYMM-GNURX Toolchain](https://llvm-gcc-renesas.com/ja/rx-download-toolchains/)

これらのToolchainを利用してソースコードをビルド出来る開発環境を作りたい。

# Windowsにe2 studioをインストールする

GCC for Renesasを使ったプロジェクトを作成できるIDEとしてe2 studioを使う。
e2 studioでRX631をターゲットとして開発出来るのはWindows版のみとなっているため、Windows版をインストールする。
Linux版のe2 studioも存在するが、残念ながらRX Familyには対応していない(現在はRA, RZのみ対応)らしい。

[統合開発環境 e2 studio | Renesas](https://www.renesas.com/jp/ja/software-tool/e-studio#overview)

インストール時には、特に、追加ソフトウェアのGCC Toolchains & UtilitiesにあるGCC for Renesas RXのインストールにチェックを入れておくように。

![](https://storage.googleapis.com/zenn-user-upload/697235b5a422-20220707.png)
![](https://storage.googleapis.com/zenn-user-upload/3f61409031ed-20220707.png)
![](https://storage.googleapis.com/zenn-user-upload/61fc85b729dd-20220707.png)

# e2 studio for WindowsでRX631をターゲットとしたプロジェクトを作成する

## GCC for Renesas RX C/C++ Executable Projectを作成

![](https://storage.googleapis.com/zenn-user-upload/b986f10d2a16-20220707.png)

## Project nameを入力

![](https://storage.googleapis.com/zenn-user-upload/4011a26ff655-20220707.png)

## Toolchain Settings / Device Settingsを設定する

言語はC言語かC++か、開発に利用したい方を選ぶと良い。
今回は、C言語で作成する。

![](https://storage.googleapis.com/zenn-user-upload/d710bb24752e-20220707.png)

ターゲットデバイスは、今回は以下のCPUボードを対象にするので、`R5F5631MDxFL`を選択する。

> CPUボード	RX631（R5F5631MDDFL）
>  [HM-StarterKit 手のひらサイズのマイクロマウス学習キット](https://rt-net.jp/products/hm-starterkit/#:~:text=CPU%E3%83%9C%E3%83%BC%E3%83%89-,RX631%EF%BC%88R5F5631MDDFL%EF%BC%89,-%E3%83%A2%E3%83%BC%E3%82%BF)

## 残りはデフォルトのまま

![](https://storage.googleapis.com/zenn-user-upload/0a775d17111b-20220707.png)

![](https://storage.googleapis.com/zenn-user-upload/15d0310b7015-20220707.png)

![](https://storage.googleapis.com/zenn-user-upload/bca5fc4cbb3e-20220707.png)

![](https://storage.googleapis.com/zenn-user-upload/3e3dd15af017-20220707.png)

![](https://storage.googleapis.com/zenn-user-upload/10a2ef2cceba-20220707.png)

# e2 studioでプロジェクトをビルドする

e2 studioはプロジェクトをビルドする際に、Makefileを自動的に生成してくれる。
今回のビルドは自動で生成されるMakefileが欲しい。これをLinux環境に移行出来れば、同じようにコンパイルが出来るようになる。

![](https://storage.googleapis.com/zenn-user-upload/4dabe7d4afee-20220707.png)

- generate ディレクトリ
    - e2 studioが自動で生成したRX600 Family用ライブラリ。これはe2 studioで生成するしかない。
- src ディレクトリ
    - main関数を含むソースコードが配置されている
- HardwareDebug ディレクトリ
    - ビルド時に生成される中間ファイルなどがこのフォルダ内にある。目当てのMakefileもこの中にあるが、1つではなく、`*.in`や`*.mk`など、複数ファイルに分割されているのでいい感じに読んでいく必要がある。

# Makefileを作る

この作業は[Hiroya-W/rx631_gcc_projects](https://github.com/Hiroya-W/rx631_gcc_projects)のリポジトリにある。

最終的に生成したいのは、以下の2つ。

- `PROJECT_NAME.elf`
- `PROJECT_NAME.mot`

ビルドされたファイルの確認に以下のターゲットを実行する。

- `PROJECT_NAME.siz`

これは`HardwareDebug/makefile`に生成ルールが記述されていて、このうち、`PROJECT_NAME.mot`、`PROJECT_NAME.siz`は`PROJECT_NAME.elf`から生成されることが分かる。
`PROJECT_NAME.elf`は、`generate/*.c`、`generate/*.S`、`src/*.c`をコンパイルしてオブジェクトファイルを生成し、それらをリンクすることで、生成出来るようになっている。
オブジェクトファイルの生成は、`HardwareDebug/generate/subdir.mk`、`HardwareDebug/src/subdir.mk`にそれぞれ書かれている。
これを確認すると、コンパイラは`rx-elf-gcc`を使っていて、コンパイルオプションは各ファイルごとに`FILENAME.in`が生成されて、その中に書かれているので、それを確認していけばいい。

それぞれ書き出すとこんな感じになる。
環境に応じて、以下の項目を置き換えてほしい。

- `PROJECT_NAME`
	- 生成される`.elf`と`.mot`の名前に使用される
- `OBJS`の`./src/sample_project.o`
	- `src`フォルダ内に生成されたmain関数を含むソースファイル名の拡張子を`.o`に変更したもの
	- 今回は`./src/sample_project.c`がある。

```makefile
CC = rx-elf-gcc

PROJECT_NAME = project_name
OBJS = ./src/sample_project.o ./generate/hwinit.o ./generate/inthandler.o ./generate/start.o ./generate/vects.o
INCLUDE = -I./generate
CFLAGS = -O0 -ffunction-sections -fdata-sections -fdiagnostics-parseable-fixits -Wstack-usage=100 -g2 -mcpu=rx600 -misa=v1 -mlittle-endian-data -Wa,-adlnh=$*.lst
ASFLAGS = -Wa,--gdwarf2
DEPFLAGS = -MMD -MP -MF $*.d -MT $@
LINKER = ./generate/linker_script.ld
LDFLAGS = -Wl,--start-group -lm -lc -lgcc -Wl,--end-group -nostartfiles -Wl,-e_PowerON_Reset -Wl,-M=$*.map

all: $(PROJECT_NAME).elf $(PROJECT_NAME).mot $(PROJECT_NAME).siz

%.elf: $(OBJS)
	$(CC) $(CFLAGS) -o $@ $(OBJS) -T $(LINKER) $(LDFLAGS)

%.mot: %.elf
	rx-elf-objcopy $< -O srec -I elf32-rx-be-ns $@

# Idiom found at https://www.gnu.org/software/make/manual/html_node/Force-Targets.html
FORCE:

%.siz: %.elf FORCE
	rx-elf-size --format=berkeley $<

.PRECIOUS: %.o

%.o: %.S
	$(CC) -x assembler-with-cpp $(ASFLAGS) $(CFLAGS) $(DEPFLAGS) $< -c -o $@

%.o: %.c
	$(CC) $(CFLAGS) $(INCLUDE) $(DEPFLAGS) $< -c -o $@

.PHONY: clean
clean:
	-rm */*.d
	-rm */*.o
	-rm */*.lst
	-rm *.elf
	-rm *.map
	-rm *.mot

```

このMakefileには環境に依存するファイルパスなどが含まれていないので、Windows依存ではなくなった。
後は、Linux上でMakefileからコンパイルを行えるようにすればいい。

# Linux上でGCC for Renesas Toolchainのインストール

ここではLinux環境として、Ubuntu 20.04を用いる。

[GCC for Renesas X.X.X.YYYYMM-GNURX Toolchain](https://llvm-gcc-renesas.com/ja/rx-download-toolchains/)から、`GCC for Renesas 8.3.0.202202-GNURX Linux Toolchain (ELF)`のLinux向けの`gcc-8.3.0.202202-GNURX-ELF.run`を取得した。

```bash
chmod +x gcc-8.3.0.202202-GNURX-ELF.run
gcc-8.3.0.202202-GNURX-ELF.run -y -p /opt/gcc-renesas-toolchains
```

ここでは、`/opt/gcc-renesas-toolchains`にToolchainを配置した。

| オプション | 内容 |
| -------- | -------- |
| `-y`    | インタラクティブな入力無しで実行    |
| `-p /path/to/dir` | インストールディレクトリとして`/path/to/dir`を利用する | 

Toolchainへパスを通しておく。

```bashrc:~/.bashrc
export PATH="/opt/gcc-renesas-toolchains/bin:${PATH}"
```

## Linux環境からマイコンへプログラムを書き込む

参考：[番外編 Part4 書き込む準備、ツールの用意！ – しゅうのマイクロマウス研修](https://rt-net.jp/mobility/archives/13994)

### rxprogのRX631用の設定とビルド

Linux環境からRX631マイコンへプログラムを書き込むには有志の書き込みツールである[rxprog](https://github.com/hirakuni45/RX/tree/master/rxprog)を利用する。

ソースコードのビルドにboostライブラリ、clangのインストールが必要なので事前にインストールしておく。

aptを使ってインストールしたboostライブラリは、`/usr/include/boost`に配置されている。

```bash
sudo apt install libboost-dev clang
```

参考サイトを参考に、以下の5つのファイルを編集し、RX631用に書き換える。
Ubuntuのようにaptを使ってboostライブラリをインストールした場合、システムでパスが通っているincludeディレクトリに配置されるので、Makefileの`INC_SYS`を編集する必要はない。

- `rx631_protocol.hpp`
- `rx_prog.hpp`
- `rx_prog.conf`
- `main.cpp`
- `Makefile`

書き換えたものは [Hiroya-W/RX/tree/rx_prog-RX631/rxprog](https://github.com/Hiroya-W/RX/tree/rx_prog-RX631/rxprog)に置いている。

書き換えができれば、`make`でビルドし、インストールする。

```bash
make
make install
```

バイナリとコンフィグファイルは`/usr/local/bin`に配置される。

### rxprogを使ってLinux環境から書き込む

書き込む際には、`rx_prog`のバイナリと、`rx_prog.conf`のコンフィグファイルが同じディレクトリに存在している必要がある。
`make install`を使わずに、`$HOME/bin`など別の場所に配置する場合はコンフィグファイルも同時に移動することを忘れないように。

```bash
rx_prog --verbose --progress --speed=115200 --device=RX631 --write PROJECT_NAME.mot
```

## Hiroya-W/rxmicon-devcontainer

Docker + VSCodeがある環境向けに、 [Hiroya-W/rx631-devcontainer](https://github.com/Hiroya-W/rx631-devcontainer)を作っておこうと思っている。

現状は、C++の開発環境、Toolchainのインストール、RX631用書き込みツールがインストールされている。

なお、Toolchainをソースコードからビルドせずに、Toolchainインストーラを取得して展開することにしているので、Renesasアカウントの登録とインストーラのダウンロードが必須の状態になっている。

## 参考記事

この記事やツールが無ければ開発環境を整えることが出来なかったと思います。ありがとうございました。

- [番外編 Part1 MacOSで環境構築を始めよう！ – しゅうのマイクロマウス研修](https://rt-net.jp/mobility/archives/13282)
- [hirakuni45/RX: Renesas RX Microcontroller, C++ framework, Library, Sample](https://github.com/hirakuni45/RX)

[^1]: つらいです。
