---
title: "Docker + VSCodeでZennで記事を書く環境を作る"
emoji: "🔖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Docker", "VSCode"]
published: false
---

# 目標

- Zenn CLIを使って記事を管理
- VSCodeで記事を執筆
- textlintを導入し、文章レビューを行う
- これらをDockerで環境を構築する

# 環境構築

ここではホスト側の`~/zenn-docs`をワークスペースとして環境構築を進めていくことにします。

```
host$ mkdir ~/zenn-docs
host$ cd ~/zenn-docs
```

## Dockerfile

コンテナイメージを作成するための`Dockerfile`を記述します。
`docker`ディレクトリを作成し、その中に`Dockerfile`を作成します。

```
host$ mkdir ~/zenn-docs/docker
host$ vim ~/zenn-docs/docker/Dockerfile
```

```Dockerfile:Dockerfile
FROM node:lts-alpine

RUN apk update && \
    apk --no-cache add --virtual=git-deps git

USER node

WORKDIR /workspaces
```

通常、コンテナ内から作成した記事などのファイルは`root`ユーザで作成されます。
しかし、ホストでは一般ユーザであることがほとんどで、一般ユーザではルートユーザで作成したファイルを編集することは出来ません。

今回利用するイメージには、ホストの一般ユーザと同じuidとgidを持つユーザ(1000:1000)として`node`ユーザが存在します。
`node`ユーザとしてコンテナ内で操作をすることで、この問題を解決することが出来ます。

:::details 用意されているユーザ一覧を見る

`USER node`の記述を削除した状態で、コンテナをビルドして`root`ユーザとしてコンテナにアタッチしておきます。
用意されているユーザ一覧は`/etc/passwd`で見ることが出来ます。

```
root# cat /etc/passwd

...
node:x:1000:1000:Linux User,,,:/home/node:/bin/sh
```

:::

## docker-compose.yml

用意した`Dockerfile`を用いて、コンテナを起動する方法を`docker-compose.yml`に記述します。

```
host$ vim ~/zenn-docs/docker-compose.yml
```

```yml:docker-compose.yml
version: '3'
services:
  main:
    build: ./docker
    image: zenn-base
    container_name: zenn-docs
    volumes:
      - .:/workspaces/zenn-docs:cached
    ports:
      - "8000:8000"
    tty: true
```

Zennの記事データはホスト側に置き、そのディレクトリ`.`を、コンテナ内の`/workspaces/zenn-docs`にマウントすることにします。

## devcontainer.json

VSCodeのRemote Container用の設定を記述します。

まずは、VSCodeで`~/zenn-docs`フォルダを開きます。

コマンドパレットから、`> Remote-Containers: Add Development Container Configuration Files...`を実行し、`devcontainer.json`を生成します。

![](https://storage.googleapis.com/zenn-user-upload/50hmfy60poeqd7ebkum8luhwwqg5)

`.devcontainer`フォルダに、`devcontainer.json`と`docker-compose.yml`ファイルが生成されていると思います。

![](https://storage.googleapis.com/zenn-user-upload/gyxs04smiexeepcwfhc3r4mc1n16)

このうち、`docker-compose.yml`ファイルは必要ないので、削除しておきます。

```
host$ rm .devcontainer/docker-compose.yml
```

`devcontainer.json`を以下のように修正します。

```diff:devcontainer.json
 {
     "name": "Existing Docker Compose (Extend)",
     "dockerComposeFile": [
         "../docker-compose.yml",
-        "docker-compose.yml",
     ],
     "service": "main",
-    "workspaceFolder": "/workspace",
+    "workspaceFolder": "/workspaces/zenn-docs",
     "settings": {
         "terminal.integrated.shell.linux": null
     },
     "extensions": []
 }
```

VSCodeのRemote Containerで開いた際のワークスペースを`workspacceFolder`に指定し、ここでは`workspaces/zenn-docs`にしています。
`workspaces/zenn-docs`は、`Dockerfile`に書いていたように、ホスト側のZennの記事データをコンテナ内にマウントしたディレクトリです。

## SSH agent

コンテナ内でホストのSSH keyを用いてGitが使えるようにしておきます。
これで、いつもどおりGitHubのリモートリポジトリに対して`git pull`や`git push`が出来るようになります。

ここでは、公式ドキュメントに従って進めていきます。

https://code.visualstudio.com/docs/remote/containers#_using-ssh-keys

:::message alert
Windowsユーザは、注意が必要です。

ホスト側の`zenn-docs`をワークスペースとしていましたが、これをWSL内のファイルシステムに配置している場合はLinux向けのSSH agentの設定を行う必要があります。
つまり、ワークスペースを`\\wsl$\Ubuntu-18.04\home\user\zenn-docs`としているような場合です。

一方、`C:\Users\User\zenn-docs`のように、Windowsのファイルシステムに配置した場合はWindows向けのSSH agentの設定を行う必要があります。

この記事では、Linux向けのSSH agentの設定手順を記載しています。
:::

ホスト側にパッケージを導入します。

```
Host$ sudo apt update
Host$ sudo apt install openssh-client socat
```

次に、`ssh-agent`をバックグラウンドで実行しておきます。

```
Host$ eval "$(ssh-agent -s)"
```

SSH keyをSSH agentに追加します。
なお、ここでは、秘密鍵が`id_rsa`というファイル名で生成されていることを前提としています。

```
Host$ ssh-add $HOME/.ssh/id_rsa
```

次に、`~/.bash_profile`に以下を追記します。
これで、常にSSH agentが実行されるようにしておきます。

```bash:~/.bash_profile
if [ -z "$SSH_AUTH_SOCK" ]; then
   # Check for a currently running instance of the agent
   RUNNING_AGENT="`ps -ax | grep 'ssh-agent -s' | grep -v grep | wc -l | tr -d '[:space:]'`"
   if [ "$RUNNING_AGENT" = "0" ]; then
        # Launch a new instance of the agent
        ssh-agent -s &> $HOME/.ssh/ssh-agent
   fi
   eval `cat $HOME/.ssh/ssh-agent`
fi
```

一旦再起動した後、`ssh-add -l`コマンドを実行した際に、登録した鍵が表示されていればOKです。

```
Host$ ssh-add -l
2048 SHA256:... /home/user/.ssh/id_rsa
```

## コンテナをビルドしVSCodeをアタッチする

ファイルを配置出来れば、Remote Containerの機能を用いて、Dockerコンテナをビルド・起動し、VSCodeにアタッチします。
コマンドパレットから`> Remote-Containers: Reopen in Container`を実行します。

![](https://storage.googleapis.com/zenn-user-upload/sfwlz56l0wj2p49ap4oz96j60t7m)

VSCodeにアタッチできると、左下の表示が`Dev Container:~`に変化します。
また、ターミナルからDockerコンテナ内の環境でコマンドを叩くことが出来るようになります。

![](https://storage.googleapis.com/zenn-user-upload/xnvr52af6ey49q1por87admfkh3h)

例えば、`id`コマンドを実行すると、`node`ユーザになっていることが分かります。
`ls`すると、コンテナ内にマウントされた`docker`ディレクトリや`docker-compose.yml`が表示されると思います。

また、コンテナ内で`ssh-add -l`した際に同じ鍵が表示されるか、GitHubに接続できるかもを確認しておきます。

```
node$ ssh-add -l
2048 SHA256:... /home/user/.ssh/id_rsa
node$ ssh -T git@github.com
Hi ...! You've successfully authenticated, but GitHub does not provide shell access.
```

## Zenn用のディレクトリや環境を作る

コンテナ内でコマンドを実行していきます。

### Zenn CLIで記事を初めて書く場合

https://zenn.dev/zenn/articles/install-zenn-cli
公式を参考に、Zenn CLIを導入します。

```
node$ npm init --yes
node$ npm install zen-cli
node$ npx zenn init
```

### 既にZenn CLIを使って記事を書いている場合

既にZenn CLIを使っている場合、ディレクトリに`package.json`があるので、
それを利用してパッケージをインストールします。

```
node$ npm install
```
